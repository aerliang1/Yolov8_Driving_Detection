{% extends "common/base.html" %}

{% block title %}æƒé™ç®¡ç† - ç®¡ç†å‘˜{% endblock %}

{% block sidebar %}
<ul class="layui-nav layui-nav-tree">
  <li class="layui-nav-item">
    <a href="/admin/dashboard">
      <i class="layui-icon layui-icon-console"></i> æ§åˆ¶å°
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/system_log">
      <i class="layui-icon layui-icon-log"></i> ç³»ç»Ÿæ—¥å¿—
    </a>
  </li>
  <li class="layui-nav-item layui-this">
    <a href="/admin/permissions">
      <i class="layui-icon layui-icon-user"></i> æƒé™ç®¡ç†
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/records">
      <i class="layui-icon layui-icon-list"></i> æ£€æµ‹è®°å½•
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/profile">
      <i class="layui-icon layui-icon-set"></i> ä¸ªäººä¿¡æ¯
    </a>
  </li>
</ul>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">æƒé™ç®¡ç†</h1>
  <p style="margin: 10px 0 0 0; color: #666;">ç®¡ç†ç”¨æˆ·è§’è‰²å’Œæƒé™è®¾ç½®</p>
</div>

<div class="content-card">
  <div class="content-header">
    <i class="layui-icon layui-icon-user"></i> ç”¨æˆ·ç®¡ç†
    <div style="float: right;">
      <button class="layui-btn layui-btn-sm" id="add-user-btn">
        <i class="layui-icon layui-icon-add-1"></i> æ·»åŠ ç”¨æˆ·
      </button>
      <button class="layui-btn layui-btn-sm layui-btn-normal" id="refresh-users">
        <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
      </button>
    </div>
  </div>

  <!-- æœç´¢æ  -->
  <div class="content-body" style="padding-bottom: 0;">
    <div class="layui-form" style="margin-bottom: 20px;">
      <div class="layui-form-item">
        <div class="layui-input-inline" style="width: 300px;">
          <input type="text" id="search-input" placeholder="æœç´¢ç”¨æˆ·å..." class="layui-input">
        </div>
        <div class="layui-input-inline" style="width: 100px;">
          <button class="layui-btn" id="search-btn">
            <i class="layui-icon layui-icon-search"></i> æœç´¢
          </button>
        </div>
        <div class="layui-input-inline" style="width: 100px;">
          <button class="layui-btn layui-btn-primary" id="clear-search">
            æ¸…ç©º
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="content-body">
    <table class="layui-table" id="users-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>ç”¨æˆ·å</th>
          <th>è§’è‰²</th>
          <th>çŠ¶æ€</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="users-tbody">
        <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
      </tbody>
    </table>

    <div id="no-users" style="text-align: center; padding: 40px; color: #999; display: none;">
      <i class="layui-icon layui-icon-face-cry" style="font-size: 48px; margin-bottom: 10px;"></i>
      <p>æš‚æ— ç”¨æˆ·æ•°æ®</p>
    </div>

    <div id="loading" style="text-align: center; padding: 40px;">
      <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>
      <p>åŠ è½½ä¸­...</p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
layui.use(['element', 'layer', 'form'], function() {
  var element = layui.element;
  var layer = layui.layer;
  var form = layui.form;
  var $ = layui.jquery;

  // è¾…åŠ©å‡½æ•°
  function showConfirm(message, callback) {
    layer.confirm(message, {
      icon: 3,
      title: 'ç¡®è®¤æ“ä½œ'
    }, function(index) {
      callback();
      layer.close(index);
    });
  }

  // ç›´æ¥å®šä¹‰showConfirmå‡½æ•°ï¼Œç¡®ä¿å¯¹è¯æ¡†æ­£å¸¸å·¥ä½œ
  window.showConfirm = function(message, callback) {
    console.log('ğŸ” æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œæ¶ˆæ¯:', message);
    layer.confirm(message, {
      title: 'ç¡®è®¤æ“ä½œ',
      btn: ['ç¡®å®š', 'å–æ¶ˆ'],
      icon: 3
    }, function(index) {
      console.log('âœ… ç”¨æˆ·ç‚¹å‡»ç¡®è®¤');
      layer.close(index);
      if (callback) callback();
    }, function(index) {
      console.log('âŒ ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ');
      layer.close(index);
    });
  };

  function showSuccess(message) {
    layer.msg(message, {icon: 1});
  }

  function showError(message) {
    layer.msg(message, {icon: 2});
  }

  // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
  loadUsers();

  // æœç´¢åŠŸèƒ½
  $('#search-btn').on('click', function() {
    loadUsers();
  });

  // å›è½¦æœç´¢
  $('#search-input').on('keypress', function(e) {
    if (e.which === 13) {
      loadUsers();
    }
  });

  // æ¸…ç©ºæœç´¢
  $('#clear-search').on('click', function() {
    $('#search-input').val('');
    loadUsers();
  });

  $('#refresh-users').on('click', function() {
    loadUsers();
  });

  $('#add-user-btn').on('click', function() {
    showAddUserModal();
  });

  // ä¿®æ”¹è§’è‰²æŒ‰é’®äº‹ä»¶
  $(document).on('click', '.edit-role-btn', function() {
    var userId = $(this).data('id');
    var username = $(this).data('username');
    var currentRole = $(this).data('role');
    editUserRole(userId, username, currentRole);
  });

  // åˆ é™¤ç”¨æˆ·æŒ‰é’®äº‹ä»¶
  $(document).on('click', '.delete-user-btn', function() {
    var userId = $(this).data('id');
    var username = $(this).data('username');
    deleteUser(userId, username);
  });

  function loadUsers() {
    $('#loading').show();
    $('#users-tbody').empty();
    $('#no-users').hide();

    var searchTerm = $('#search-input').val().trim();
    var url = '/api/users';
    if (searchTerm) {
      url += '?search=' + encodeURIComponent(searchTerm);
    }

    $.ajax({
      url: url,
      type: 'GET',
      success: function(response) {
        $('#loading').hide();

        if (response.success && response.data.length > 0) {
          renderUsers(response.data);
        } else {
          $('#no-users').show();
        }
      },
      error: function(xhr, status, error) {
        $('#loading').hide();
        showError('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥ï¼š' + error);
        $('#no-users').show();
      }
    });
  }

  function renderUsers(users) {
    var tbody = $('#users-tbody');
    tbody.empty();

    users.forEach(function(user) {
      var row = $('<tr>');
      row.append('<td>' + user.id + '</td>');
      row.append('<td>' + user.username + '</td>');
      row.append('<td>' + getRoleBadge(user.role) + '</td>');
      row.append('<td>' + getStatusBadge(user.status) + '</td>');

      var actionButtons = '<div class="layui-btn-group">';
      actionButtons += '<button class="layui-btn layui-btn-xs edit-role-btn" data-id="' + user.id + '" data-username="' + user.username + '" data-role="' + user.role + '">ä¿®æ”¹è§’è‰²</button>';
      if (user.username !== '{{ session.username }}') {
        actionButtons += '<button class="layui-btn layui-btn-xs layui-btn-danger delete-user-btn" data-id="' + user.id + '" data-username="' + user.username + '">åˆ é™¤</button>';
      }
      actionButtons += '</div>';

      row.append('<td>' + actionButtons + '</td>');

      tbody.append(row);
    });
  }

  function getRoleBadge(role) {
    var badges = {
      'driver': '<span class="layui-badge layui-bg-blue">é©¾é©¶å‘˜</span>',
      'monitor': '<span class="layui-badge layui-bg-green">ç›‘æ§äººå‘˜</span>',
      'admin': '<span class="layui-badge layui-bg-red">ç®¡ç†å‘˜</span>'
    };
    return badges[role] || '<span class="layui-badge">æœªçŸ¥</span>';
  }

  function getStatusBadge(status) {
    if (status === 'active') {
      return '<span class="layui-badge layui-bg-green">æ­£å¸¸</span>';
    } else {
      return '<span class="layui-badge layui-bg-gray">ç¦ç”¨</span>';
    }
  }

  function showAddUserModal() {
    var modalContent = '<div style="padding: 20px;">' +
      '<form class="layui-form" id="add-user-form">' +
        '<div class="layui-form-item">' +
          '<label class="layui-form-label">ç”¨æˆ·å</label>' +
          '<div class="layui-input-block">' +
            '<input type="text" name="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" class="layui-input" lay-verify="required">' +
          '</div>' +
        '</div>' +
        '<div class="layui-form-item">' +
          '<label class="layui-form-label">å¯†ç </label>' +
          '<div class="layui-input-block">' +
            '<input type="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " class="layui-input" lay-verify="required">' +
          '</div>' +
        '</div>' +
        '<div class="layui-form-item">' +
          '<label class="layui-form-label">è§’è‰²</label>' +
          '<div class="layui-input-block">' +
            '<select name="role" lay-verify="required">' +
              '<option value="">è¯·é€‰æ‹©è§’è‰²</option>' +
              '<option value="driver">é©¾é©¶å‘˜</option>' +
              '<option value="monitor">ç›‘æ§äººå‘˜</option>' +
              '<option value="admin">ç®¡ç†å‘˜</option>' +
            '</select>' +
          '</div>' +
        '</div>' +
        '<div class="layui-form-item">' +
          '<div class="layui-input-block">' +
            '<button type="submit" class="layui-btn" lay-submit lay-filter="add-user-submit">æ·»åŠ ç”¨æˆ·</button>' +
            '<button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">å–æ¶ˆ</button>' +
          '</div>' +
        '</div>' +
      '</form>' +
    '</div>';

    layer.open({
      type: 1,
      title: 'æ·»åŠ ç”¨æˆ·',
      area: ['500px', '400px'],
      content: modalContent,
      success: function() {
        form.render();
        form.on('submit(add-user-submit)', function(data) {
          $.ajax({
            url: '/api/users',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data.field),
            success: function(response) {
              if (response.success) {
                showSuccess('ç”¨æˆ·æ·»åŠ æˆåŠŸ');
                layer.closeAll();
                loadUsers();
              } else {
                showError('ç”¨æˆ·æ·»åŠ å¤±è´¥ï¼š' + response.message);
              }
            },
            error: function(xhr, status, error) {
              showError('ç”¨æˆ·æ·»åŠ å¤±è´¥ï¼š' + error);
            }
          });
          return false;
        });
      }
    });
  }

  // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿onclickè°ƒç”¨
  window.editUserRole = function(userId, username, currentRole) {
    var modalContent = '<div style="padding: 20px;">' +
      '<form class="layui-form" id="edit-role-form">' +
        '<div class="layui-form-item">' +
          '<label class="layui-form-label">å½“å‰è§’è‰²</label>' +
          '<div class="layui-input-block">' +
            '<input type="text" value="' + getRoleName(currentRole) + '" class="layui-input" readonly>' +
          '</div>' +
        '</div>' +
        '<div class="layui-form-item">' +
          '<label class="layui-form-label">æ–°è§’è‰²</label>' +
          '<div class="layui-input-block">' +
            '<select name="role" lay-verify="required">' +
              '<option value="">è¯·é€‰æ‹©æ–°è§’è‰²</option>' +
              '<option value="driver" ' + (currentRole === 'driver' ? 'selected' : '') + '>é©¾é©¶å‘˜</option>' +
              '<option value="monitor" ' + (currentRole === 'monitor' ? 'selected' : '') + '>ç›‘æ§äººå‘˜</option>' +
              '<option value="admin" ' + (currentRole === 'admin' ? 'selected' : '') + '>ç®¡ç†å‘˜</option>' +
            '</select>' +
          '</div>' +
        '</div>' +
        '<div class="layui-form-item">' +
          '<div class="layui-input-block">' +
            '<button type="submit" class="layui-btn" lay-submit lay-filter="edit-role-submit">ç¡®è®¤ä¿®æ”¹</button>' +
            '<button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">å–æ¶ˆ</button>' +
          '</div>' +
        '</div>' +
      '</form>' +
    '</div>';

    layer.open({
      type: 1,
      title: 'ä¿®æ”¹ç”¨æˆ·è§’è‰² - ' + username,
      area: ['400px', '300px'],
      content: modalContent,
      success: function() {
        form.render();
        form.on('submit(edit-role-submit)', function(data) {
          if (data.field.role === currentRole) {
            showError('æ–°è§’è‰²ä¸èƒ½ä¸å½“å‰è§’è‰²ç›¸åŒ');
            return false;
          }

          $.ajax({
            url: '/api/users/' + userId + '/role',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data.field),
            success: function(response) {
              if (response.success) {
                showSuccess('ç”¨æˆ·è§’è‰²ä¿®æ”¹æˆåŠŸ');
                layer.closeAll();
                loadUsers();
              } else {
                showError('ç”¨æˆ·è§’è‰²ä¿®æ”¹å¤±è´¥ï¼š' + response.message);
              }
            },
            error: function(xhr, status, error) {
              showError('ç”¨æˆ·è§’è‰²ä¿®æ”¹å¤±è´¥ï¼š' + error);
            }
          });
          return false;
        });
      }
    });
  };

  function getRoleName(role) {
    var roleNames = {
      'driver': 'é©¾é©¶å‘˜',
      'monitor': 'ç›‘æ§äººå‘˜',
      'admin': 'ç®¡ç†å‘˜'
    };
    return roleNames[role] || role;
  }

  function deleteUser(userId, username) {
    console.log('ğŸ” åˆ é™¤ç”¨æˆ·:', userId, username);
    showConfirm('ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "' + username + '" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼', function() {
      console.log('âœ… å¼€å§‹åˆ é™¤ç”¨æˆ·:', userId);
      $.ajax({
        url: '/api/users/' + userId,
        type: 'DELETE',
        success: function(response) {
          console.log('ğŸ“¥ åˆ é™¤ç”¨æˆ·å“åº”:', response);
          if (response.success) {
            showSuccess('ç”¨æˆ·åˆ é™¤æˆåŠŸ');
            loadUsers();
          } else {
            showError('ç”¨æˆ·åˆ é™¤å¤±è´¥ï¼š' + response.message);
          }
        },
        error: function(xhr, status, error) {
          console.log('âŒ åˆ é™¤ç”¨æˆ·å¤±è´¥:', {xhr: xhr, status: status, error: error});
          showError('ç”¨æˆ·åˆ é™¤å¤±è´¥ï¼š' + error);
        }
      });
    });
  }
});
{% endblock %} 