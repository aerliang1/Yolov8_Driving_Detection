{% extends "common/base.html" %}

{% block title %}ä¸ªäººä¿¡æ¯ - ç®¡ç†å‘˜{% endblock %}

{% block sidebar %}
<ul class="layui-nav layui-nav-tree">
  <li class="layui-nav-item">
    <a href="/admin/dashboard">
      <i class="layui-icon layui-icon-console"></i> æ§åˆ¶å°
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/system_log">
      <i class="layui-icon layui-icon-log"></i> ç³»ç»Ÿæ—¥å¿—
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/permissions">
      <i class="layui-icon layui-icon-user"></i> æƒé™ç®¡ç†
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/records">
      <i class="layui-icon layui-icon-list"></i> æ£€æµ‹è®°å½•
    </a>
  </li>
  <li class="layui-nav-item layui-this">
    <a href="/admin/profile">
      <i class="layui-icon layui-icon-set"></i> ä¸ªäººä¿¡æ¯
    </a>
  </li>
</ul>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">ä¸ªäººä¿¡æ¯</h1>
  <p style="margin: 10px 0 0 0; color: #666;">ç®¡ç†æ‚¨çš„ä¸ªäººä¿¡æ¯å’Œè´¦æˆ·è®¾ç½®</p>
</div>

<div class="layui-row layui-col-space20">
  <!-- åŸºæœ¬ä¿¡æ¯ -->
  <div class="layui-col-md6">
    <div class="content-card">
      <div class="content-header">
        <i class="layui-icon layui-icon-user"></i> åŸºæœ¬ä¿¡æ¯
      </div>
      <div class="content-body">
        <form class="layui-form" id="profile-form">
          <div class="layui-form-item">
            <label class="layui-form-label">ç”¨æˆ·å</label>
            <div class="layui-input-block">
              <input type="text" name="username" value="{{ user_info.username }}" class="layui-input" readonly>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">è§’è‰²</label>
            <div class="layui-input-block">
              <input type="text" value="ç®¡ç†å‘˜" class="layui-input" readonly>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">æ³¨å†Œæ—¶é—´</label>
            <div class="layui-input-block">
              <input type="text" value="{{ user_info.register_time }}" class="layui-input" readonly>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">æœ€åç™»å½•</label>
            <div class="layui-input-block">
              <input type="text" value="{{ user_info.last_login }}" class="layui-input" readonly>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ä¿®æ”¹å¯†ç  -->
  <div class="layui-col-md6">
    <div class="content-card">
      <div class="content-header">
        <i class="layui-icon layui-icon-password"></i> ä¿®æ”¹å¯†ç 
      </div>
      <div class="content-body">
        <form class="layui-form" id="password-form">
          <div class="layui-form-item">
            <label class="layui-form-label">å½“å‰å¯†ç </label>
            <div class="layui-input-block">
              <input type="password" name="current_password" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " class="layui-input" lay-verify="required">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">æ–°å¯†ç </label>
            <div class="layui-input-block">
              <input type="password" name="new_password" placeholder="è¯·è¾“å…¥æ–°å¯†ç " class="layui-input" lay-verify="required|password">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">ç¡®è®¤å¯†ç </label>
            <div class="layui-input-block">
              <input type="password" name="confirm_password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " class="layui-input" lay-verify="required|confirmPassword">
            </div>
          </div>

          <div class="layui-form-item">
            <div class="layui-input-block">
              <button class="layui-btn" lay-submit lay-filter="change-password">
                <i class="layui-icon layui-icon-ok"></i> ä¿®æ”¹å¯†ç 
              </button>
              <button type="reset" class="layui-btn layui-btn-primary">é‡ç½®</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ä¿®æ”¹ç”¨æˆ·å -->
<div class="content-card">
  <div class="content-header">
    <i class="layui-icon layui-icon-edit"></i> ä¿®æ”¹ç”¨æˆ·å
  </div>
  <div class="content-body">
    <form class="layui-form" id="username-form">
      <div class="layui-form-item">
        <label class="layui-form-label">å½“å‰ç”¨æˆ·å</label>
        <div class="layui-input-inline">
          <input type="text" value="{{ user_info.username }}" class="layui-input" readonly>
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">æ–°ç”¨æˆ·å</label>
        <div class="layui-input-inline">
          <input type="text" name="new_username" placeholder="è¯·è¾“å…¥æ–°ç”¨æˆ·å" class="layui-input" lay-verify="required|username">
        </div>
        <div class="layui-form-mid layui-word-aux">ç”¨æˆ·åé•¿åº¦3-20ä¸ªå­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">ç¡®è®¤å¯†ç </label>
        <div class="layui-input-inline">
          <input type="password" name="confirm_password_username" placeholder="è¯·è¾“å…¥å¯†ç ç¡®è®¤" class="layui-input" lay-verify="required">
        </div>
      </div>

      <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn" lay-submit lay-filter="change-username">
            <i class="layui-icon layui-icon-ok"></i> ä¿®æ”¹ç”¨æˆ·å
          </button>
          <button type="reset" class="layui-btn layui-btn-primary">é‡ç½®</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ç³»ç»Ÿè®¾ç½® -->
<div class="content-card">
  <div class="content-header">
    <i class="layui-icon layui-icon-set"></i> ç³»ç»Ÿè®¾ç½®
  </div>
  <div class="content-body">
    <form class="layui-form" id="system-settings-form">
      <div class="layui-form-item">
        <label class="layui-form-label">ç³»ç»Ÿåç§°</label>
        <div class="layui-input-block">
          <input type="text" name="system_name" value="ç‹¬ç«‹ç®¡ç†å‘˜ç³»ç»Ÿ" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">æ£€æµ‹é˜ˆå€¼</label>
        <div class="layui-input-block">
          <input type="number" name="detection_threshold" value="0.7" min="0" max="1" step="0.1" class="layui-input">
          <div class="layui-form-mid layui-word-aux">ç–²åŠ³æ£€æµ‹çš„æ•æ„Ÿåº¦é˜ˆå€¼ï¼ˆ0-1ä¹‹é—´ï¼‰</div>
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">æ£€æµ‹é—´éš”</label>
        <div class="layui-input-block">
          <input type="number" name="detection_interval" value="2" min="1" max="10" class="layui-input">
          <div class="layui-form-mid layui-word-aux">æ‘„åƒå¤´æ£€æµ‹çš„æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰</div>
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">æ—¥å¿—ä¿ç•™</label>
        <div class="layui-input-block">
          <input type="number" name="log_retention" value="30" min="1" max="365" class="layui-input">
          <div class="layui-form-mid layui-word-aux">ç³»ç»Ÿæ—¥å¿—ä¿ç•™å¤©æ•°</div>
        </div>
      </div>

      <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn" lay-submit lay-filter="save-settings">
            <i class="layui-icon layui-icon-ok"></i> ä¿å­˜è®¾ç½®
          </button>
          <button type="reset" class="layui-btn layui-btn-primary">é‡ç½®</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/layui.js"></script>
<script>
layui.use(['form', 'layer'], function() {
  var form = layui.form;
  var layer = layui.layer;
  var $ = layui.jquery;

  // ä½¿ç”¨å…¨å±€çš„showConfirmå‡½æ•°ï¼Œæ·»åŠ è°ƒè¯•ä¿¡æ¯
  var originalShowConfirm = window.showConfirm;
  window.showConfirm = function(message, callback) {
    console.log('ğŸ” æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œæ¶ˆæ¯:', message);
    originalShowConfirm(message, function() {
      console.log('âœ… ç”¨æˆ·ç‚¹å‡»ç¡®è®¤');
      if (callback) callback();
    });
  };

  function showSuccess(message) {
    layer.msg(message, {icon: 1});
  }

  function showError(message) {
    layer.msg(message, {icon: 2});
  }

  // è¡¨å•éªŒè¯è§„åˆ™
  form.verify({
    password: [
      /^[\S]{6,20}$/,
      'å¯†ç å¿…é¡»6åˆ°20ä½ï¼Œä¸”ä¸èƒ½å‡ºç°ç©ºæ ¼'
    ],
    confirmPassword: function(value) {
      var password = $('input[name=new_password]').val();
      if (value !== password) {
        return 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´';
      }
    },
    username: [
      /^[a-zA-Z0-9_]{3,20}$/,
      'ç”¨æˆ·åé•¿åº¦3-20ä¸ªå­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿'
    ]
  });

  // ä¿®æ”¹å¯†ç è¡¨å•æäº¤
  form.on('submit(change-password)', function(data) {
    var loading = layer.load(1, {shade: [0.1, '#000']});
    
    // æ„é€ æ­£ç¡®çš„è¯·æ±‚æ•°æ®
    var requestData = {
      old_password: data.field.current_password,
      new_password: data.field.new_password,
      confirm_password: data.field.confirm_password
    };
    
    $.ajax({
      url: '/api/change-password',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(requestData),
      success: function(response) {
        layer.close(loading);
        if (response.success) {
          layer.msg('å¯†ç ä¿®æ”¹æˆåŠŸ', {icon: 1});
          $('#password-form')[0].reset();
        } else {
          layer.msg(response.message || 'å¯†ç ä¿®æ”¹å¤±è´¥', {icon: 2});
        }
      },
      error: function(xhr, status, error) {
        layer.close(loading);
        layer.msg('å¯†ç ä¿®æ”¹å¤±è´¥ï¼š' + error, {icon: 2});
      }
    });
    return false;
  });

  // ä¿®æ”¹ç”¨æˆ·åè¡¨å•æäº¤
  form.on('submit(change-username)', function(data) {
    var loading = layer.load(1, {shade: [0.1, '#000']});
    
    // æ„é€ æ­£ç¡®çš„è¯·æ±‚æ•°æ®
    var requestData = {
      old_username: '{{ session.username }}',
      new_username: data.field.new_username,
      confirm_password: data.field.confirm_password_username
    };
    
    $.ajax({
      url: '/api/change-username',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(requestData),
      success: function(response) {
        layer.close(loading);
        if (response.success) {
          layer.msg('ç”¨æˆ·åä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•', {icon: 1});
          $('#username-form')[0].reset();
          setTimeout(function() { window.location.href = '/login'; }, 2000);
        } else {
          layer.msg(response.message || 'ç”¨æˆ·åä¿®æ”¹å¤±è´¥', {icon: 2});
        }
      },
      error: function(xhr, status, error) {
        layer.close(loading);
        layer.msg('ç”¨æˆ·åä¿®æ”¹å¤±è´¥ï¼š' + error, {icon: 2});
      }
    });
    return false;
  });

  // ä¿å­˜ç³»ç»Ÿè®¾ç½®
  form.on('submit(save-settings)', function(data) {
    var loading = layer.load(1, {shade: [0.1, '#000']});
    $.ajax({
      url: '/api/admin/system-settings',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(data.field),
      success: function(response) {
        layer.close(loading);
        if (response.success) {
          layer.msg('ç³»ç»Ÿè®¾ç½®ä¿å­˜æˆåŠŸ', {icon: 1});
        } else {
          layer.msg('ç³»ç»Ÿè®¾ç½®ä¿å­˜å¤±è´¥ï¼š' + response.message, {icon: 2});
        }
      },
      error: function(xhr, status, error) {
        layer.close(loading);
        layer.msg('ç³»ç»Ÿè®¾ç½®ä¿å­˜å¤±è´¥ï¼š' + error, {icon: 2});
      }
    });
    return false;
  });
});
</script>
{% endblock %} 