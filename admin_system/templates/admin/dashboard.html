{% extends "common/base.html" %}

{% block title %}ç®¡ç†æ§åˆ¶å° - ç‹¬ç«‹ç®¡ç†å‘˜ç³»ç»Ÿ{% endblock %}

{% block sidebar %}
<ul class="layui-nav layui-nav-tree">
  <li class="layui-nav-item layui-this">
    <a href="/admin/dashboard">
      <i class="layui-icon layui-icon-console"></i> æ§åˆ¶å°
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/system_log">
      <i class="layui-icon layui-icon-log"></i> ç³»ç»Ÿæ—¥å¿—
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/permissions">
      <i class="layui-icon layui-icon-user"></i> æƒé™ç®¡ç†
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/records">
      <i class="layui-icon layui-icon-list"></i> æ£€æµ‹è®°å½•
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/profile">
      <i class="layui-icon layui-icon-set"></i> ä¸ªäººä¿¡æ¯
    </a>
  </li>
</ul>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">ç®¡ç†æ§åˆ¶å°</h1>
  <p style="margin: 10px 0 0 0; color: #666;">ç³»ç»Ÿæ¦‚è§ˆå’Œå¿«é€Ÿæ“ä½œ</p>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="layui-row layui-col-space20">
  <div class="layui-col-md3">
    <div class="content-card">
      <div class="content-body" style="text-align: center; padding: 30px;">
        <i class="layui-icon layui-icon-user" style="font-size: 48px; color: #009688; margin-bottom: 10px;"></i>
        <h3 id="total-users">0</h3>
        <p style="color: #666; margin: 0;">æ€»ç”¨æˆ·æ•°</p>
      </div>
    </div>
  </div>

  <div class="layui-col-md3">
    <div class="content-card">
      <div class="content-body" style="text-align: center; padding: 30px;">
        <i class="layui-icon layui-icon-camera" style="font-size: 48px; color: #FFB800; margin-bottom: 10px;"></i>
        <h3 id="online-drivers">0</h3>
        <p style="color: #666; margin: 0;">åœ¨çº¿é©¾é©¶å‘˜</p>
      </div>
    </div>
  </div>

  <div class="layui-col-md3">
    <div class="content-card">
      <div class="content-body" style="text-align: center; padding: 30px;">
        <i class="layui-icon layui-icon-chart" style="font-size: 48px; color: #FF5722; margin-bottom: 10px;"></i>
        <h3 id="today-detections">0</h3>
        <p style="color: #666; margin: 0;">ä»Šæ—¥æ£€æµ‹</p>
      </div>
    </div>
  </div>

  <div class="layui-col-md3">
    <div class="content-card">
      <div class="content-body" style="text-align: center; padding: 30px;">
        <i class="layui-icon layui-icon-close" style="font-size: 48px; color: #FF5722; margin-bottom: 10px;"></i>
        <h3 id="fatigue-alerts">0</h3>
        <p style="color: #666; margin: 0;">ç–²åŠ³è­¦æŠ¥</p>
      </div>
    </div>
  </div>
</div>

<!-- å¿«é€Ÿæ“ä½œå’Œç³»ç»ŸçŠ¶æ€åŒæ’ -->
<div class="layui-row layui-col-space20">
  <div class="layui-col-md4">
    <div class="content-card">
      <div class="content-header">
        <i class="layui-icon layui-icon-set"></i> å¿«é€Ÿæ“ä½œ
      </div>
      <div class="content-body">
        <div class="layui-btn-container" style="display: flex; flex-direction: column; gap: 24px; align-items: center; margin-top: 24px;">
          <a href="/admin/system_log" class="layui-btn" style="width: 180px; border-radius: 8px; box-shadow: 0 2px 8px rgba(102,126,234,0.10); font-size: 16px; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
            <i class="layui-icon layui-icon-log" style="font-size: 20px; margin-right: 8px;"></i> ç³»ç»Ÿæ—¥å¿—
          </a>
          <a href="/admin/permissions" class="layui-btn" style="width: 180px; border-radius: 8px; box-shadow: 0 2px 8px rgba(102,126,234,0.10); font-size: 16px; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
            <i class="layui-icon layui-icon-user" style="font-size: 20px; margin-right: 8px;"></i> æƒé™ç®¡ç†
          </a>
          <a href="/admin/records" class="layui-btn" style="width: 180px; border-radius: 8px; box-shadow: 0 2px 8px rgba(102,126,234,0.10); font-size: 16px; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
            <i class="layui-icon layui-icon-list" style="font-size: 20px; margin-right: 8px;"></i> æ£€æµ‹è®°å½•
          </a>
        </div>
        <style>
        .layui-btn-container .layui-btn:hover {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: #fff;
          box-shadow: 0 4px 16px rgba(102,126,234,0.18);
          transform: translateY(-2px) scale(1.04);
        }
        </style>
      </div>
    </div>
  </div>
  <div class="layui-col-md8">
    <div class="content-card">
      <div class="content-header">
        <i class="layui-icon layui-icon-chart"></i> ç³»ç»ŸçŠ¶æ€
      </div>
      <div class="content-body">
        <div class="layui-form">
          <div class="layui-form-item">
            <label class="layui-form-label">ç³»ç»ŸçŠ¶æ€</label>
            <div class="layui-input-block">
              <span class="layui-badge layui-bg-green">æ­£å¸¸è¿è¡Œ</span>
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">CPUä½¿ç”¨ç‡</label>
            <div class="layui-input-block">
              <div class="layui-progress" lay-filter="cpu-usage">
                <div class="layui-progress-bar" lay-percent="45%"></div>
              </div>
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">å†…å­˜ä½¿ç”¨ç‡</label>
            <div class="layui-input-block">
              <div class="layui-progress" lay-filter="memory-usage">
                <div class="layui-progress-bar" lay-percent="62%"></div>
              </div>
            </div>
          </div>
          <div class="layui-form-item">
            <label class="layui-form-label">ç£ç›˜ä½¿ç”¨ç‡</label>
            <div class="layui-input-block">
              <div class="layui-progress" lay-filter="disk-usage">
                <div class="layui-progress-bar" lay-percent="28%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ç»“æŸ -->

<!-- æœ€è¿‘æ´»åŠ¨ -->
<div class="content-card">
  <div class="content-header">
    <i class="layui-icon layui-icon-time"></i> æœ€è¿‘æ´»åŠ¨
  </div>
  <div class="content-body">
    <table class="layui-table" id="recent-activities">
      <thead>
        <tr>
          <th>æ—¶é—´</th>
          <th>ç”¨æˆ·</th>
          <th>æ“ä½œ</th>
          <th>è¯¦æƒ…</th>
          <th>IPåœ°å€</th>
        </tr>
      </thead>
      <tbody id="activities-tbody">
        <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
      </tbody>
    </table>

    <div id="no-activities" style="text-align: center; padding: 40px; color: #999; display: none;">
      <i class="layui-icon layui-icon-face-smile" style="font-size: 48px; margin-bottom: 10px;"></i>
      <p>æš‚æ— æœ€è¿‘æ´»åŠ¨</p>
    </div>
  </div>
</div>

<!-- ç³»ç»Ÿå…¬å‘Š -->
<div class="content-card">
  <div class="content-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px 8px 0 0; padding: 15px 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center;">
        <i class="layui-icon layui-icon-notice" style="font-size: 18px; margin-right: 8px;"></i>
        <span style="font-weight: 600; font-size: 16px;">ç³»ç»Ÿå…¬å‘Š</span>
      </div>
      <button class="layui-btn layui-btn-sm" 
              style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 6px; padding: 6px 12px; font-size: 12px; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; line-height: 1;" 
              onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
              onmouseout="this.style.background='rgba(255,255,255,0.2)'"
              onclick="addAnnouncement()">
        <i class="layui-icon layui-icon-add-1" style="font-size: 12px; margin-right: 4px;"></i>
        <span style="font-size: 12px;">å‘å¸ƒå…¬å‘Š</span>
      </button>
    </div>
  </div>
  <div class="content-body" style="padding: 20px; background: #f8f9fa; border-radius: 0 0 8px 8px;">
    <div id="announcements">
      <!-- å…¬å‘Šå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
    </div>
    <div id="no-announcements" style="text-align: center; padding: 40px; color: #6c757d; display: none; background: white; border-radius: 8px; margin: 10px 0;">
      <i class="layui-icon layui-icon-notice" style="font-size: 48px; margin-bottom: 15px; color: #dee2e6;"></i>
      <p style="font-size: 14px; margin: 0;">æš‚æ— ç³»ç»Ÿå…¬å‘Š</p>
      <p style="font-size: 12px; color: #adb5bd; margin: 10px 0 0 0;">ç‚¹å‡»ä¸Šæ–¹"å‘å¸ƒå…¬å‘Š"æŒ‰é’®åˆ›å»ºç¬¬ä¸€æ¡å…¬å‘Š</p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
layui.use(['element', 'layer', 'form'], function() {
  var element = layui.element;
  var layer = layui.layer;
  var form = layui.form;
  var $ = layui.jquery;

  // å…¨å±€å‡½æ•°å®šä¹‰
  function loadDashboardData() {
    console.log('ğŸ”„ å¼€å§‹åŠ è½½ä»ªè¡¨æ¿æ•°æ®...');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    $('#total-users').text('åŠ è½½ä¸­...');
    $('#online-drivers').text('åŠ è½½ä¸­...');
    $('#today-detections').text('åŠ è½½ä¸­...');
    $('#fatigue-alerts').text('åŠ è½½ä¸­...');

    $.ajax({
      url: '/api/dashboard-stats',
      type: 'GET',
      timeout: 10000, // 10ç§’è¶…æ—¶
      success: function(response) {
        console.log('âœ… ä»ªè¡¨æ¿æ•°æ®åŠ è½½æˆåŠŸ:', response);
        if (response.success && response.data) {
          var data = response.data;
          $('#total-users').text(data.total_users || 0);
          $('#online-drivers').text(data.online_drivers || 0);
          $('#today-detections').text(data.today_detections || 0);
          $('#fatigue-alerts').text(data.fatigue_alerts || 0);

          // æ›´æ–°è¿›åº¦æ¡
          element.progress('cpu-usage', (data.cpu_usage || 0) + '%');
          element.progress('memory-usage', (data.memory_usage || 0) + '%');
          element.progress('disk-usage', (data.disk_usage || 0) + '%');
          
          console.log('ğŸ“Š æ•°æ®æ›´æ–°å®Œæˆ:', {
            total_users: data.total_users,
            online_drivers: data.online_drivers,
            today_detections: data.today_detections,
            fatigue_alerts: data.fatigue_alerts
          });
        } else {
          console.error('âŒ ä»ªè¡¨æ¿æ•°æ®æ ¼å¼é”™è¯¯:', response);
          // è®¾ç½®é»˜è®¤å€¼
          $('#total-users').text('0');
          $('#online-drivers').text('0');
          $('#today-detections').text('0');
          $('#fatigue-alerts').text('0');
        }
      },
      error: function(xhr, status, error) {
        console.error('âŒ åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', {
          status: status,
          error: error,
          statusCode: xhr.status,
          responseText: xhr.responseText
        });
        // è®¾ç½®é»˜è®¤å€¼
        $('#total-users').text('0');
        $('#online-drivers').text('0');
        $('#today-detections').text('0');
        $('#fatigue-alerts').text('0');
      }
    });
  }

  function loadRecentActivities() {
    console.log('ğŸ”„ å¼€å§‹åŠ è½½æœ€è¿‘æ´»åŠ¨...');
    $('#no-activities').hide();
    $.ajax({
      url: '/api/recent-activities',
      type: 'GET',
      timeout: 10000,
      success: function(response) {
        console.log('âœ… æœ€è¿‘æ´»åŠ¨åŠ è½½æˆåŠŸ:', response);
        if (response.success && response.data && response.data.length > 0) {
          renderActivities(response.data);
          $('#no-activities').hide();
        } else {
          $('#activities-tbody').empty();
          $('#no-activities').show();
        }
      },
      error: function(xhr, status, error) {
        console.error('âŒ åŠ è½½æœ€è¿‘æ´»åŠ¨å¤±è´¥:', error);
        $('#activities-tbody').empty();
        $('#no-activities').show();
      }
    });
  }

  function renderActivities(activities) {
    var tbody = $('#activities-tbody');
    tbody.empty();
    activities.forEach(function(activity) {
      var row = $('<tr>');
      row.append('<td>' + formatDateTime(activity.timestamp) + '</td>');
      row.append('<td>' + (activity.username || 'æœªçŸ¥') + '</td>');
      row.append('<td>' + (activity.action || '-') + '</td>');
      row.append('<td>' + (activity.details || '-') + '</td>');
      row.append('<td>' + (activity.ip_address || '-') + '</td>');
      tbody.append(row);
    });
  }

  function formatDateTime(timestamp) {
    if (!timestamp) return '-';
    // å¤„ç†æ ‡å‡†å­—ç¬¦ä¸²
    if (typeof timestamp === 'string') {
      // å½¢å¦‚ '2025-07-06 17:00:00'
      if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(timestamp)) {
        return timestamp;
      }
      return timestamp;
    }
    // å¤„ç†Dateå¯¹è±¡
    if (timestamp instanceof Date && !isNaN(timestamp.getTime())) {
      return timestamp.getFullYear() + '-' +
        String(timestamp.getMonth() + 1).padStart(2, '0') + '-' +
        String(timestamp.getDate()).padStart(2, '0') + ' ' +
        String(timestamp.getHours()).padStart(2, '0') + ':' +
        String(timestamp.getMinutes()).padStart(2, '0') + ':' +
        String(timestamp.getSeconds()).padStart(2, '0');
    }
    return timestamp;
  }

  // å…¬å‘Šç›¸å…³
  function loadAnnouncements() {
    $('#no-announcements').hide();
    $.ajax({
      url: '/api/announcements',
      type: 'GET',
      timeout: 10000,
      success: function(response) {
        if (response.success && response.data && response.data.length > 0) {
          renderAnnouncements(response.data);
          $('#no-announcements').hide();
        } else {
          $('#announcements').empty();
          $('#no-announcements').show();
        }
      },
      error: function() {
        $('#announcements').empty();
        $('#no-announcements').show();
      }
    });
  }

  function renderAnnouncements(announcements) {
    var container = $('#announcements');
    container.empty();
    announcements.forEach(function(announcement) {
      var announcementHtml = `
        <div class="layui-card announcement-card" style="margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease;">
          <div class="layui-card-header" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #dee2e6; padding: 15px 20px; border-radius: 8px 8px 0 0; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
              <div style="flex: 1;">
                <span style="font-weight: 600; color: #2c3e50; font-size: 16px;">${announcement.title}</span>
                <div style="margin-top: 8px; display: flex; align-items: center; gap: 15px;">
                  <div style="display: flex; align-items: center;">
                    <i class="layui-icon layui-icon-time" style="color: #6c757d; font-size: 12px;"></i>
                    <span style="color: #6c757d; font-size: 12px; margin-left: 5px;">å‘å¸ƒæ—¶é—´ï¼š${formatDateTime(announcement.created_at)}</span>
                  </div>
                  <div style="display: flex; align-items: center;">
                    <i class="layui-icon layui-icon-user" style="color: #6c757d; font-size: 12px;"></i>
                    <span style="color: #6c757d; font-size: 12px; margin-left: 5px;">ç®¡ç†å‘˜</span>
                  </div>
                </div>
              </div>
              <div class="announcement-actions" style="opacity: 0; transition: opacity 0.3s ease; display: flex; align-items: center;">
                <button class="layui-btn layui-btn-danger layui-btn-xs" 
                        style="border-radius: 4px; padding: 6px 10px; font-size: 11px; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; line-height: 1;" 
                        onclick="deleteAnnouncement(${announcement.id})"
                        title="åˆ é™¤å…¬å‘Š">
                  <i class="layui-icon layui-icon-delete" style="font-size: 12px; margin-right: 2px;"></i>
                  <span style="font-size: 11px;">åˆ é™¤</span>
                </button>
              </div>
            </div>
          </div>
          <div class="layui-card-body" style="padding: 20px; background: #fff; border-radius: 0 0 8px 8px; line-height: 1.6; color: #495057;">
            <div style="white-space: pre-wrap; word-wrap: break-word;">${announcement.content}</div>
          </div>
        </div>
      `;
      container.append(announcementHtml);
    });
    // æ‚¬åœæ•ˆæœ
    container.find('.announcement-card').hover(
      function() {
        $(this).find('.announcement-actions').css('opacity', '1');
        $(this).css('transform', 'translateY(-2px)');
        $(this).css('box-shadow', '0 4px 12px rgba(0,0,0,0.15)');
      },
      function() {
        $(this).find('.announcement-actions').css('opacity', '0');
        $(this).css('transform', 'translateY(0)');
        $(this).css('box-shadow', '0 2px 8px rgba(0,0,0,0.1)');
      }
    );
  }

  function addAnnouncement() {
    layui.use(['layer', 'form'], function() {
      var layer = layui.layer;
      var form = layui.form;
      var $ = layui.jquery;
      layer.open({
        type: 1,
        title: '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; margin: -15px -20px 20px -20px; border-radius: 8px 8px 0 0;"><i class="layui-icon layui-icon-notice" style="margin-right: 8px;"></i>å‘å¸ƒç³»ç»Ÿå…¬å‘Š</div>',
        area: ['650px', '450px'],
        skin: 'layui-layer-molv',
        content: `
          <div style="padding: 20px; background: #f8f9fa;">
            <form class="layui-form" id="announcement-form" style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
              <div class="layui-form-item">
                <label class="layui-form-label" style="color: #495057; font-weight: 600;">å…¬å‘Šæ ‡é¢˜</label>
                <div class="layui-input-block">
                  <input type="text" name="title" placeholder="è¯·è¾“å…¥å…¬å‘Šæ ‡é¢˜" 
                         class="layui-input" lay-verify="required" 
                         style="border-radius: 6px; border: 1px solid #dee2e6; padding: 10px 15px; transition: border-color 0.3s ease;"
                         onfocus="this.style.borderColor='#667eea'" 
                         onblur="this.style.borderColor='#dee2e6'">
                </div>
              </div>
              <div class="layui-form-item layui-form-text">
                <label class="layui-form-label" style="color: #495057; font-weight: 600;">å…¬å‘Šå†…å®¹</label>
                <div class="layui-input-block">
                  <textarea name="content" placeholder="è¯·è¾“å…¥å…¬å‘Šå†…å®¹ï¼Œæ”¯æŒæ¢è¡Œ" 
                            class="layui-textarea" lay-verify="required" 
                            style="border-radius: 6px; border: 1px solid #dee2e6; padding: 15px; min-height: 120px; resize: vertical; transition: border-color 0.3s ease;"
                            onfocus="this.style.borderColor='#667eea'" 
                            onblur="this.style.borderColor='#dee2e6'"></textarea>
                </div>
              </div>
              <div class="layui-form-item" style="margin-top: 30px;">
                <div class="layui-input-block" style="text-align: center;">
                  <button class="layui-btn" lay-submit lay-filter="publish-announcement" 
                          style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 6px; padding: 10px 25px; font-size: 14px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; line-height: 1;"
                          onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'"
                          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
                    <i class="layui-icon layui-icon-ok" style="font-size: 14px; margin-right: 5px;"></i>
                    <span style="font-size: 14px;">å‘å¸ƒå…¬å‘Š</span>
                  </button>
                  <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll()" 
                          style="border-radius: 6px; padding: 10px 25px; font-size: 14px; margin-left: 15px; border: 1px solid #dee2e6; color: #6c757d; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; line-height: 1;"
                          onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.borderColor='#adb5bd'"
                          onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#dee2e6'">
                    <i class="layui-icon layui-icon-close" style="font-size: 14px; margin-right: 5px;"></i>
                    <span style="font-size: 14px;">å–æ¶ˆ</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        `,
        success: function() {
          form.on('submit(publish-announcement)', function(data) {
            $.ajax({
              url: '/api/announcements',
              type: 'POST',
              contentType: 'application/json',
              data: JSON.stringify(data.field),
              success: function(response) {
                if (response.success) {
                  showSuccess('å…¬å‘Šå‘å¸ƒæˆåŠŸ');
                  layer.closeAll();
                  loadAnnouncements();
                } else {
                  showError('å…¬å‘Šå‘å¸ƒå¤±è´¥ï¼š' + response.message);
                }
              },
              error: function(xhr, status, error) {
                showError('å…¬å‘Šå‘å¸ƒå¤±è´¥ï¼š' + error);
              }
            });
            return false;
          });
        }
      });
    });
  }
  window.addAnnouncement = addAnnouncement;

  function deleteAnnouncement(announcementId) {
    showConfirm('ç¡®å®šè¦åˆ é™¤æ­¤å…¬å‘Šå—ï¼Ÿ', function() {
      $.ajax({
        url: '/api/announcements/' + announcementId,
        type: 'DELETE',
        success: function(response) {
          if (response.success) {
            showSuccess('å…¬å‘Šåˆ é™¤æˆåŠŸ');
            loadAnnouncements();
          } else {
            showError('å…¬å‘Šåˆ é™¤å¤±è´¥ï¼š' + response.message);
          }
        },
        error: function(xhr, status, error) {
          showError('å…¬å‘Šåˆ é™¤å¤±è´¥ï¼š' + error);
        }
      });
    });
  }
  window.deleteAnnouncement = deleteAnnouncement;

  // é¡µé¢åˆå§‹åŒ–
  console.log('ğŸš€ Dashboardé¡µé¢åˆå§‹åŒ–å¼€å§‹...');
  
  // å»¶è¿Ÿä¸€ç‚¹åŠ è½½æ•°æ®ï¼Œç¡®ä¿é¡µé¢å®Œå…¨æ¸²æŸ“
  setTimeout(function() {
    console.log('ğŸ“‹ å¼€å§‹é¦–æ¬¡æ•°æ®åŠ è½½...');
    loadDashboardData();
    loadRecentActivities();
    loadAnnouncements();
  }, 500);

  // è®¾ç½®å®šæ—¶åˆ·æ–°ï¼ˆæ¯60ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œé¿å…è¿‡äºé¢‘ç¹ï¼‰
  var refreshInterval = setInterval(function() {
    console.log('ğŸ”„ å®šæ—¶åˆ·æ–°æ•°æ®...');
    loadDashboardData();
    loadRecentActivities();
    loadAnnouncements();
  }, 60000);

  // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
  $(window).on('beforeunload', function() {
    clearInterval(refreshInterval);
  });
});
{% endblock %}
