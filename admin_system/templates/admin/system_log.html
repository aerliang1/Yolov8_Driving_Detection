{% extends "common/base.html" %}

{% block title %}ç³»ç»Ÿæ—¥å¿— - ç®¡ç†å‘˜{% endblock %}

{% block sidebar %}
<ul class="layui-nav layui-nav-tree">
  <li class="layui-nav-item">
    <a href="/admin/dashboard">
      <i class="layui-icon layui-icon-console"></i> æ§åˆ¶å°
    </a>
  </li>
  <li class="layui-nav-item layui-this">
    <a href="/admin/system_log">
      <i class="layui-icon layui-icon-log"></i> ç³»ç»Ÿæ—¥å¿—
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/permissions">
      <i class="layui-icon layui-icon-user"></i> æƒé™ç®¡ç†
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/records">
      <i class="layui-icon layui-icon-list"></i> æ£€æµ‹è®°å½•
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/profile">
      <i class="layui-icon layui-icon-set"></i> ä¸ªäººä¿¡æ¯
    </a>
  </li>
</ul>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">ç³»ç»Ÿæ—¥å¿—</h1>
  <p style="margin: 10px 0 0 0; color: #666;">æŸ¥çœ‹ç³»ç»Ÿæ“ä½œæ—¥å¿—å’Œæ´»åŠ¨è®°å½•</p>
</div>

<div class="content-card">
  <div class="content-header">
    <i class="layui-icon layui-icon-log"></i> ç³»ç»Ÿæ—¥å¿—
    <div style="float: right;">
      <button class="layui-btn layui-btn-sm layui-btn-warm" id="debug-db">
        <i class="layui-icon layui-icon-engine"></i> è°ƒè¯•
      </button>
      <button class="layui-btn layui-btn-sm" id="refresh-logs">
        <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
      </button>
      <button class="layui-btn layui-btn-sm layui-btn-normal" id="export-logs">
        <i class="layui-icon layui-icon-export"></i> å¯¼å‡º
      </button>
      <button class="layui-btn layui-btn-sm layui-btn-danger" id="clear-logs">
        <i class="layui-icon layui-icon-delete"></i> æ¸…ç©º
      </button>
    </div>
  </div>
  <div class="content-body">
    <!-- æœç´¢ç­›é€‰ -->
    <div class="layui-form" style="margin-bottom: 20px;">
      <div class="layui-row layui-col-space10">
        <div class="layui-col-md3">
          <div class="layui-form-item">
            <label class="layui-form-label">ç”¨æˆ·è§’è‰²</label>
            <div class="layui-input-block">
              <select name="role-filter" id="role-filter">
                <option value="">å…¨éƒ¨</option>
                <option value="driver">é©¾é©¶å‘˜</option>
                <option value="monitor">ç›‘æ§äººå‘˜</option>
                <option value="admin">ç®¡ç†å‘˜</option>
              </select>
            </div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="layui-form-item">
            <label class="layui-form-label">æ“ä½œç±»å‹</label>
            <div class="layui-input-block">
              <select name="action-filter" id="action-filter">
                <option value="">å…¨éƒ¨</option>
                <option value="ç”¨æˆ·ç™»å½•">ç”¨æˆ·ç™»å½•</option>
                <option value="ç”¨æˆ·é€€å‡ºç™»å½•">ç”¨æˆ·é€€å‡ºç™»å½•</option>
                <option value="ç”¨æˆ·æ³¨å†Œ">ç”¨æˆ·æ³¨å†Œ</option>
                <option value="æ‰§è¡Œå›¾ç‰‡æ£€æµ‹">æ‰§è¡Œå›¾ç‰‡æ£€æµ‹</option>
                <option value="æ‰§è¡Œè§†é¢‘æ£€æµ‹">æ‰§è¡Œè§†é¢‘æ£€æµ‹</option>
                <option value="æ‰§è¡Œæ‘„åƒå¤´æ£€æµ‹">æ‰§è¡Œæ‘„åƒå¤´æ£€æµ‹</option>
                <option value="ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶">ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶</option>
                <option value="æ·»åŠ ç”¨æˆ·">æ·»åŠ ç”¨æˆ·</option>
                <option value="ä¿®æ”¹ç”¨æˆ·è§’è‰²">ä¿®æ”¹ç”¨æˆ·è§’è‰²</option>
                <option value="åˆ é™¤ç”¨æˆ·">åˆ é™¤ç”¨æˆ·</option>
                <option value="ä¿®æ”¹å¯†ç ">ä¿®æ”¹å¯†ç </option>
                <option value="ä¿®æ”¹ç”¨æˆ·å">ä¿®æ”¹ç”¨æˆ·å</option>
                <option value="æ¸…ç©ºç³»ç»Ÿæ—¥å¿—">æ¸…ç©ºç³»ç»Ÿæ—¥å¿—</option>
                <option value="å¯¼å‡ºç³»ç»Ÿæ—¥å¿—">å¯¼å‡ºç³»ç»Ÿæ—¥å¿—</option>
                <option value="ä¸Šä¼ æ¨¡å‹æ–‡ä»¶">ä¸Šä¼ æ¨¡å‹æ–‡ä»¶</option>
                <option value="åˆ é™¤æ¨¡å‹æ–‡ä»¶">åˆ é™¤æ¨¡å‹æ–‡ä»¶</option>
                <option value="åˆ‡æ¢æ¨¡å‹">åˆ‡æ¢æ¨¡å‹</option>
              </select>
            </div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="layui-form-item">
            <label class="layui-form-label">æ—¶é—´èŒƒå›´</label>
            <div class="layui-input-block">
              <input type="text" name="date-range" id="date-range" placeholder="é€‰æ‹©æ—¶é—´èŒƒå›´" class="layui-input">
            </div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="layui-form-item">
            <div class="layui-input-block">
              <button class="layui-btn" id="search-btn">
                <i class="layui-icon layui-icon-search"></i> æœç´¢
              </button>
              <button class="layui-btn layui-btn-primary" id="reset-btn">
                <i class="layui-icon layui-icon-refresh-1"></i> é‡ç½®
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ—¥å¿—è¡¨æ ¼ -->
    <table class="layui-table" id="logs-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>ç”¨æˆ·å</th>
          <th>è§’è‰²</th>
          <th>æ“ä½œ</th>
          <th>è¯¦æƒ…</th>
          <th>IPåœ°å€</th>
          <th>æ—¶é—´</th>
        </tr>
      </thead>
      <tbody id="logs-tbody">
        <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
      </tbody>
    </table>

    <div id="no-logs" style="text-align: center; padding: 40px; color: #999; display: none;">
      <i class="layui-icon layui-icon-face-smile" style="font-size: 48px; margin-bottom: 10px;"></i>
      <p>æš‚æ— ç³»ç»Ÿæ—¥å¿—</p>
    </div>

    <div id="loading" style="text-align: center; padding: 40px;">
      <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>
      <p>åŠ è½½ä¸­...</p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
layui.use(['element', 'layer', 'form', 'laydate'], function() {
  var element = layui.element;
  var layer = layui.layer;
  var form = layui.form;
  var laydate = layui.laydate;
  var $ = layui.jquery;

  // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
  console.log('ğŸš€ ç³»ç»Ÿæ—¥å¿—é¡µé¢åŠ è½½å®Œæˆ');
  console.log('ğŸ“‹ å¼€å§‹åŠ è½½æ—¥å¿—æ•°æ®...');
  loadLogs();

  // æµ‹è¯•showConfirmå‡½æ•°æ˜¯å¦æ­£å¸¸å·¥ä½œ
  setTimeout(function() {
    console.log('ğŸ§ª æµ‹è¯•showConfirmå‡½æ•°...');
    if (typeof window.showConfirm === 'function') {
      console.log('âœ… showConfirmå‡½æ•°å­˜åœ¨');
      // æ·»åŠ ä¸€ä¸ªæµ‹è¯•æŒ‰é’®
      var testBtn = $('<button class="layui-btn layui-btn-xs layui-btn-warm" style="margin-left: 10px;">æµ‹è¯•å¯¹è¯æ¡†</button>');
      $('#debug-db').after(testBtn);
      
      testBtn.on('click', function() {
        console.log('ğŸ§ª ç‚¹å‡»æµ‹è¯•æŒ‰é’®');
        showConfirm('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¯¹è¯æ¡†ï¼Œè¯·ç‚¹å‡»ç¡®å®šæˆ–å–æ¶ˆ', function() {
          console.log('âœ… æµ‹è¯•å¯¹è¯æ¡†ç¡®è®¤å›è°ƒæ‰§è¡Œ');
          showSuccess('æµ‹è¯•æˆåŠŸï¼å¯¹è¯æ¡†æ­£å¸¸å·¥ä½œ');
        });
      });
    } else {
      console.log('âŒ showConfirmå‡½æ•°ä¸å­˜åœ¨');
      showError('showConfirmå‡½æ•°æœªå®šä¹‰');
    }
  }, 1000);

  // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
  laydate.render({
    elem: '#date-range',
    type: 'datetime',
    range: true,
    format: 'yyyy-MM-dd HH:mm:ss'
  });

  // è°ƒè¯•æ•°æ®åº“çŠ¶æ€
  $('#debug-db').on('click', function() {
    console.log('å¼€å§‹æ£€æŸ¥æ•°æ®åº“çŠ¶æ€...');
    var loadingIndex = layer.load(1, {shade: [0.1, '#000']});
    
    $.ajax({
      url: '/api/debug/db-status',
      type: 'GET',
      timeout: 10000,
      success: function(response) {
        layer.close(loadingIndex);
        console.log('æ•°æ®åº“çŠ¶æ€æ£€æŸ¥ç»“æœ:', response);
        
        if (response.success) {
          var data = response.data;
          var debugInfo = `
            <div style="padding: 20px; font-family: monospace; font-size: 12px;">
              <h3>æ•°æ®åº“çŠ¶æ€æ£€æŸ¥ç»“æœ</h3>
              <p><strong>æ•°æ®åº“è¿æ¥:</strong> ${data.database_status}</p>
              <p><strong>system_logè¡¨å­˜åœ¨:</strong> ${data.system_log_table_exists ? 'æ˜¯' : 'å¦'}</p>
              <p><strong>æ—¥å¿—æ•°é‡:</strong> ${data.log_count}</p>
              <p><strong>å½“å‰ç”¨æˆ·:</strong> ${data.session_info.username} (${data.session_info.role})</p>
              <hr>
              <h4>è¡¨ç»“æ„:</h4>
              <pre>${JSON.stringify(data.table_structure, null, 2)}</pre>
              <hr>
              <h4>æœ€è¿‘æ—¥å¿—:</h4>
              <pre>${JSON.stringify(data.recent_logs, null, 2)}</pre>
            </div>
          `;
          
          layer.open({
            type: 1,
            title: 'æ•°æ®åº“è°ƒè¯•ä¿¡æ¯',
            area: ['800px', '600px'],
            content: debugInfo,
            btn: ['å…³é—­'],
            yes: function(index) {
              layer.close(index);
            }
          });
        } else {
          showError('æ£€æŸ¥æ•°æ®åº“çŠ¶æ€å¤±è´¥ï¼š' + response.message);
        }
      },
      error: function(xhr, status, error) {
        layer.close(loadingIndex);
        console.error('æ•°æ®åº“çŠ¶æ€æ£€æŸ¥å¤±è´¥:', {
          status: status,
          error: error,
          responseText: xhr.responseText,
          statusCode: xhr.status
        });
        showError('æ£€æŸ¥æ•°æ®åº“çŠ¶æ€å¤±è´¥ï¼š' + error);
      }
    });
  });

  // åˆ·æ–°æ—¥å¿—
  $('#refresh-logs').on('click', function() {
    loadLogs();
  });

  // æœç´¢æŒ‰é’®
  $('#search-btn').on('click', function() {
    loadLogs();
  });

  // é‡ç½®æŒ‰é’®
  $('#reset-btn').on('click', function() {
    $('#role-filter').val('');
    $('#action-filter').val('');
    $('#date-range').val('');
    form.render('select');
    loadLogs();
  });

  // å¯¼å‡ºæ—¥å¿—
  $('#export-logs').on('click', function() {
    exportLogs();
  });

  // æ¸…ç©ºæ—¥å¿— - ä½¿ç”¨å…¨å±€çš„showConfirmå‡½æ•°
  $('#clear-logs').on('click', function() {
    console.log('ğŸ”˜ æ¸…ç©ºæ—¥å¿—æŒ‰é’®è¢«ç‚¹å‡»');
    
    // ç›´æ¥ä½¿ç”¨å…¨å±€çš„showConfirmå‡½æ•°
    showConfirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç³»ç»Ÿæ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼', function() {
      console.log('âœ… ç”¨æˆ·ç¡®è®¤æ¸…ç©ºæ—¥å¿—');
      console.log('ğŸš€ å¼€å§‹å‘é€æ¸…ç©ºæ—¥å¿—è¯·æ±‚...');
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      var loadingIndex = layer.load(1, {shade: [0.1, '#000']});
      console.log('â³ æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ŒloadingIndex:', loadingIndex);
      
      // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
      var startTime = new Date();
      console.log('â° è¯·æ±‚å¼€å§‹æ—¶é—´:', startTime.toISOString());
      
      $.ajax({
        url: '/api/logs/clear',
        type: 'DELETE',
        timeout: 10000, // 10ç§’è¶…æ—¶
        beforeSend: function(xhr) {
          console.log('ğŸ“¤ å‘é€è¯·æ±‚å‰ï¼ŒURL:', this.url, 'Method:', this.type);
        },
        success: function(response) {
          var endTime = new Date();
          var duration = endTime - startTime;
          console.log('âœ… æ¸…ç©ºæ—¥å¿—è¯·æ±‚æˆåŠŸï¼');
          console.log('â±ï¸ è¯·æ±‚è€—æ—¶:', duration + 'ms');
          console.log('ğŸ“¥ å“åº”æ•°æ®:', response);
          
          layer.close(loadingIndex);
          console.log('ğŸ”„ å…³é—­åŠ è½½çŠ¶æ€');
          
          if (response.success) {
            console.log('ğŸ‰ æ¸…ç©ºæ—¥å¿—æ“ä½œæˆåŠŸ');
            showSuccess('ç³»ç»Ÿæ—¥å¿—æ¸…ç©ºæˆåŠŸ');
            console.log('ğŸ”„ å¼€å§‹é‡æ–°åŠ è½½æ—¥å¿—åˆ—è¡¨...');
            loadLogs();
          } else {
            console.log('âŒ æ¸…ç©ºæ—¥å¿—æ“ä½œå¤±è´¥:', response.message);
            showError('ç³»ç»Ÿæ—¥å¿—æ¸…ç©ºå¤±è´¥ï¼š' + response.message);
          }
        },
        error: function(xhr, status, error) {
          var endTime = new Date();
          var duration = endTime - startTime;
          console.log('âŒ æ¸…ç©ºæ—¥å¿—è¯·æ±‚å¤±è´¥ï¼');
          console.log('â±ï¸ è¯·æ±‚è€—æ—¶:', duration + 'ms');
          console.log('ğŸ“Š é”™è¯¯è¯¦æƒ…:', {
            status: status,
            error: error,
            statusCode: xhr.status,
            statusText: xhr.statusText,
            responseText: xhr.responseText,
            readyState: xhr.readyState
          });
          
          layer.close(loadingIndex);
          console.log('ğŸ”„ å…³é—­åŠ è½½çŠ¶æ€');
          
          var errorMsg = 'ç³»ç»Ÿæ—¥å¿—æ¸…ç©ºå¤±è´¥';
          if (xhr.status === 0) {
            errorMsg += 'ï¼šç½‘ç»œè¿æ¥å¤±è´¥';
          } else if (xhr.status === 404) {
            errorMsg += 'ï¼šAPIæ¥å£ä¸å­˜åœ¨';
          } else if (xhr.status === 500) {
            errorMsg += 'ï¼šæœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
          } else if (xhr.status === 403) {
            errorMsg += 'ï¼šæƒé™ä¸è¶³';
          } else {
            errorMsg += 'ï¼š' + error;
          }
          
          console.log('ğŸ’¬ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯:', errorMsg);
          showError(errorMsg);
        },
        complete: function(xhr, status) {
          console.log('ğŸ è¯·æ±‚å®Œæˆï¼ŒçŠ¶æ€:', status);
        }
      });
    });
  });

  function loadLogs() {
    $('#loading').show();
    $('#logs-tbody').empty();
    $('#no-logs').hide();

    var params = {
      role: $('#role-filter').val(),
      action: $('#action-filter').val(),
      date_range: $('#date-range').val()
    };

    $.ajax({
      url: '/api/logs',
      type: 'GET',
      data: params,
      success: function(response) {
        $('#loading').hide();

        if (response.success && response.data.length > 0) {
          renderLogs(response.data);
        } else {
          $('#no-logs').show();
        }
      },
      error: function(xhr, status, error) {
        $('#loading').hide();
        showError('åŠ è½½æ—¥å¿—å¤±è´¥ï¼š' + error);
        $('#no-logs').show();
      }
    });
  }

  function renderLogs(logs) {
    var tbody = $('#logs-tbody');
    tbody.empty();

    logs.forEach(function(log) {
      var row = $('<tr>');
      row.append('<td>' + log.id + '</td>');
      row.append('<td>' + log.username + '</td>');
      row.append('<td>' + getRoleBadge(log.role) + '</td>');
      row.append('<td>' + getActionBadge(log.action) + '</td>');
      row.append('<td>' + (log.details || '-') + '</td>');
      row.append('<td>' + (log.ip_address || '-') + '</td>');
      row.append('<td>' + formatDateTime(log.timestamp) + '</td>');

      tbody.append(row);
    });
  }

  function getRoleBadge(role) {
    var badges = {
      'driver': '<span class="layui-badge layui-bg-blue">é©¾é©¶å‘˜</span>',
      'monitor': '<span class="layui-badge layui-bg-green">ç›‘æ§äººå‘˜</span>',
      'admin': '<span class="layui-badge layui-bg-red">ç®¡ç†å‘˜</span>'
    };
    return badges[role] || '<span class="layui-badge">æœªçŸ¥</span>';
  }

  function getActionBadge(action) {
    var badges = {
      'ç”¨æˆ·ç™»å½•': '<span class="layui-badge" style="background-color: #16baaa;">ç™»å½•</span>',
      'ç”¨æˆ·é€€å‡ºç™»å½•': '<span class="layui-badge" style="background-color: #16baaa;">é€€å‡º</span>',
      'ç”¨æˆ·æ³¨å†Œ': '<span class="layui-badge" style="background-color: #16baaa;">æ³¨å†Œ</span>',
      'æ‰§è¡Œå›¾ç‰‡æ£€æµ‹': '<span class="layui-badge" style="background-color: #16baaa;">å›¾ç‰‡æ£€æµ‹</span>',
      'æ‰§è¡Œè§†é¢‘æ£€æµ‹': '<span class="layui-badge" style="background-color: #16baaa;">è§†é¢‘æ£€æµ‹</span>',
      'æ‰§è¡Œæ‘„åƒå¤´æ£€æµ‹': '<span class="layui-badge" style="background-color: #16baaa;">æ‘„åƒå¤´æ£€æµ‹</span>',
      'ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶': '<span class="layui-badge" style="background-color: #16baaa;">æ–‡ä»¶ä¸Šä¼ </span>',
      'æ·»åŠ ç”¨æˆ·': '<span class="layui-badge" style="background-color: #16baaa;">æ·»åŠ ç”¨æˆ·</span>',
      'ä¿®æ”¹ç”¨æˆ·è§’è‰²': '<span class="layui-badge" style="background-color: #16baaa;">ä¿®æ”¹è§’è‰²</span>',
      'åˆ é™¤ç”¨æˆ·': '<span class="layui-badge" style="background-color: #16baaa;">åˆ é™¤ç”¨æˆ·</span>',
      'ä¿®æ”¹å¯†ç ': '<span class="layui-badge" style="background-color: #16baaa;">ä¿®æ”¹å¯†ç </span>',
      'ä¿®æ”¹ç”¨æˆ·å': '<span class="layui-badge" style="background-color: #16baaa;">ä¿®æ”¹ç”¨æˆ·å</span>',
      'æ¸…ç©ºç³»ç»Ÿæ—¥å¿—': '<span class="layui-badge" style="background-color: #16baaa;">æ¸…ç©ºæ—¥å¿—</span>',
      'å¯¼å‡ºç³»ç»Ÿæ—¥å¿—': '<span class="layui-badge" style="background-color: #16baaa;">å¯¼å‡ºæ—¥å¿—</span>',
      'ä¸Šä¼ æ¨¡å‹æ–‡ä»¶': '<span class="layui-badge" style="background-color: #16baaa;">ä¸Šä¼ æ¨¡å‹</span>',
      'åˆ é™¤æ¨¡å‹æ–‡ä»¶': '<span class="layui-badge" style="background-color: #16baaa;">åˆ é™¤æ¨¡å‹</span>',
      'åˆ‡æ¢æ¨¡å‹': '<span class="layui-badge" style="background-color: #16baaa;">åˆ‡æ¢æ¨¡å‹</span>'
    };
    return badges[action] || '<span class="layui-badge" style="background-color: #16baaa;">' + action + '</span>';
  }

  function formatDateTime(timestamp) {
    if (!timestamp) return '-';
    var date = new Date(timestamp);
    if (isNaN(date.getTime())) return timestamp; // å¦‚æœè§£æå¤±è´¥ï¼Œç›´æ¥è¿”å›åŸå€¼

    return date.getFullYear() + '-' +
           String(date.getMonth() + 1).padStart(2, '0') + '-' +
           String(date.getDate()).padStart(2, '0') + ' ' +
           String(date.getHours()).padStart(2, '0') + ':' +
           String(date.getMinutes()).padStart(2, '0') + ':' +
           String(date.getSeconds()).padStart(2, '0');
  }

  function exportLogs() {
    var params = {
      role: $('#role-filter').val(),
      action: $('#action-filter').val(),
      date_range: $('#date-range').val()
    };

    var queryString = $.param(params);
    var downloadUrl = '/api/logs/export?' + queryString;

    // åˆ›å»ºä¸€ä¸ªéšè—çš„ä¸‹è½½é“¾æ¥
    var link = document.createElement('a');
    link.href = downloadUrl;
    link.download = 'system_logs.csv';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showSuccess('æ—¥å¿—å¯¼å‡ºå·²å¼€å§‹ï¼Œè¯·ç¨åæŸ¥çœ‹ä¸‹è½½æ–‡ä»¶');
  }
});
{% endblock %}