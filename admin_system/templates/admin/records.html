
{% extends "common/base.html" %}

{% block title %}æ£€æµ‹è®°å½• - ç®¡ç†å‘˜{% endblock %}

{% block sidebar %}
<ul class="layui-nav layui-nav-tree">
  <li class="layui-nav-item">
    <a href="/admin/dashboard">
      <i class="layui-icon layui-icon-console"></i> æ§åˆ¶å°
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/system_log">
      <i class="layui-icon layui-icon-log"></i> ç³»ç»Ÿæ—¥å¿—
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/permissions">
      <i class="layui-icon layui-icon-user"></i> æƒé™ç®¡ç†
    </a>
  </li>
  <li class="layui-nav-item layui-this">
    <a href="/admin/records">
      <i class="layui-icon layui-icon-list"></i> æ£€æµ‹è®°å½•
    </a>
  </li>
  <li class="layui-nav-item">
    <a href="/admin/profile">
      <i class="layui-icon layui-icon-set"></i> ä¸ªäººä¿¡æ¯
    </a>
  </li>
</ul>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">æ£€æµ‹è®°å½•ç®¡ç†</h1>
  <p style="margin: 10px 0 0 0; color: #666;">æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æ£€æµ‹è®°å½•</p>
</div>

<div class="content-card">
  <div class="content-header">
    <i class="layui-icon layui-icon-list"></i> æ£€æµ‹è®°å½•
    <div style="float: right;">
      <button class="layui-btn layui-btn-sm" id="refresh-records">
        <i class="layui-icon layui-icon-refresh"></i> åˆ·æ–°
      </button>
    </div>
  </div>
  <div class="content-body">
    <!-- æœç´¢ç­›é€‰ -->
    <div class="layui-form" style="margin-bottom: 20px;">
      <div class="layui-row layui-col-space10">
        <div class="layui-col-md3">
          <div class="layui-form-item">
            <label class="layui-form-label">æ£€æµ‹ç»“æœ</label>
            <div class="layui-input-block">
              <select name="result-filter" id="result-filter">
                <option value="">å…¨éƒ¨</option>
                <option value="normal">æ­£å¸¸</option>
                <option value="fatigue">ç–²åŠ³</option>
              </select>
            </div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="layui-form-item">
            <label class="layui-form-label">é©¾é©¶å‘˜</label>
            <div class="layui-input-block">
              <input type="text" id="driver-filter" placeholder="è¾“å…¥é©¾é©¶å‘˜ç”¨æˆ·å" class="layui-input">
            </div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="layui-form-item">
            <label class="layui-form-label">æ—¶é—´èŒƒå›´</label>
            <div class="layui-input-block">
              <input type="text" id="date-range" placeholder="é€‰æ‹©æ—¶é—´èŒƒå›´" class="layui-input">
            </div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="layui-form-item">
            <div class="layui-input-block">
              <button class="layui-btn" id="search-btn">
                <i class="layui-icon layui-icon-search"></i> æœç´¢
              </button>
              <button class="layui-btn layui-btn-primary" id="reset-btn">
                <i class="layui-icon layui-icon-refresh-1"></i> é‡ç½®
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <table class="layui-table" id="records-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>é©¾é©¶å‘˜</th>
          <th>æ£€æµ‹æ—¶é—´</th>
          <th>æ£€æµ‹æ–¹å¼</th>
          <th>æ£€æµ‹æƒ…å†µ</th>
          <th>ç–²åŠ³ç¨‹åº¦</th>
          <th>å¤„ç†çŠ¶æ€</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="records-tbody">
        <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
      </tbody>
    </table>

    <div id="no-records" style="text-align: center; padding: 40px; color: #999; display: none;">
      <i class="layui-icon layui-icon-face-cry" style="font-size: 48px; margin-bottom: 10px;"></i>
      <p>æš‚æ— æ£€æµ‹è®°å½•</p>
    </div>

    <div id="loading" style="text-align: center; padding: 40px;">
      <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>
      <p>åŠ è½½ä¸­...</p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
layui.use(['layer', 'form', 'laydate'], function() {
  var layer = layui.layer;
  var form = layui.form;
  var laydate = layui.laydate;
  var $ = layui.jquery;

  // è¾…åŠ©å‡½æ•°
  function showConfirm(message, callback) {
    layer.confirm(message, {
      icon: 3,
      title: 'ç¡®è®¤æ“ä½œ'
    }, function(index) {
      callback();
      layer.close(index);
    });
  }

  // ä½¿ç”¨å…¨å±€çš„showConfirmå‡½æ•°ï¼Œæ·»åŠ è°ƒè¯•ä¿¡æ¯
  var originalShowConfirm = window.showConfirm;
  window.showConfirm = function(message, callback) {
    console.log('ğŸ” æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œæ¶ˆæ¯:', message);
    originalShowConfirm(message, function() {
      console.log('âœ… ç”¨æˆ·ç‚¹å‡»ç¡®è®¤');
      if (callback) callback();
    });
  };

  function showSuccess(message) {
    layer.msg(message, {icon: 1});
  }

  function showError(message) {
    layer.msg(message, {icon: 2});
  }

  // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
  loadRecords();

  // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
  laydate.render({
    elem: '#date-range',
    type: 'datetime',
    range: true,
    format: 'yyyy-MM-dd HH:mm:ss'
  });

  // åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  $('#refresh-records').on('click', function() {
    loadRecords();
  });

  // æœç´¢æŒ‰é’®
  $('#search-btn').on('click', function() {
    loadRecords();
  });

  // é‡ç½®æŒ‰é’®
  $('#reset-btn').on('click', function() {
    $('#result-filter').val('');
    $('#driver-filter').val('');
    $('#date-range').val('');
    form.render('select');
    loadRecords();
  });

  function loadRecords() {
    $('#loading').show();
    $('#records-tbody').empty();
    $('#no-records').hide();

    var params = {
      result: $('#result-filter').val(),
      driver_id: $('#driver-filter').val(),
      date_range: $('#date-range').val()
    };

    $.ajax({
      url: '/api/records',
      type: 'GET',
      data: params,
      success: function(response) {
        $('#loading').hide();

        if (response.success && response.data.length > 0) {
          renderRecords(response.data);
        } else {
          $('#no-records').show();
        }
      },
      error: function(xhr, status, error) {
        $('#loading').hide();
        showError('åŠ è½½è®°å½•å¤±è´¥ï¼š' + error);
        $('#no-records').show();
      }
    });
  }

  function renderRecords(records) {
    var tbody = $('#records-tbody');
    tbody.empty();

    records.forEach(function(record) {
      var row = $('<tr>');
      row.append('<td>' + record.id + '</td>');
      row.append('<td>' + (record.username || 'æœªçŸ¥') + '</td>');
      row.append('<td>' + (record.timestamp || 'æœªçŸ¥') + '</td>');
      row.append('<td>' + getMethodName(record.method) + '</td>');
      row.append('<td>' + getResultBadge(record.result) + '</td>');
      row.append('<td>' + getFatigueBadge(record.fatigue_level) + '</td>');
      row.append('<td>' + getStatusBadge(record.status) + '</td>');

      var actionButtons = '<div class="layui-btn-group">';
      actionButtons += '<button class="layui-btn layui-btn-xs view-record-btn" data-id="' + record.id + '">';
      actionButtons += '<i class="layui-icon layui-icon-search"></i> æŸ¥çœ‹</button>';
      actionButtons += '<button class="layui-btn layui-btn-xs edit-record-btn layui-bg-blue" data-id="' + record.id + '">';
      actionButtons += '<i class="layui-icon layui-icon-edit"></i> ä¿®æ”¹</button>';
      actionButtons += '<button class="layui-btn layui-btn-xs layui-btn-danger delete-record-btn" data-id="' + record.id + '">';
      actionButtons += '<i class="layui-icon layui-icon-delete"></i> åˆ é™¤</button>';
      actionButtons += '</div>';

      row.append('<td>' + actionButtons + '</td>');
      tbody.append(row);
    });
  }

  function getMethodName(method) {
    var methodNames = {
      'image': 'å›¾ç‰‡æ£€æµ‹',
      'video': 'è§†é¢‘æ£€æµ‹',
      'camera': 'æ‘„åƒå¤´æ£€æµ‹',
      'remote': 'è¿œç¨‹æ‘„åƒå¤´'
    };
    return methodNames[method] || method;
  }

  function getResultBadge(result) {
    if (result === 'fatigue') {
      return '<span class="layui-badge layui-bg-red">ç–²åŠ³æ£€æµ‹</span>';
    } else {
      return '<span class="layui-badge layui-bg-green">æ­£å¸¸æ£€æµ‹</span>';
    }
  }

  function getFatigueBadge(fatigue_level) {
    var badges = {
      'normal': '<span class="layui-badge layui-bg-blue">æ­£å¸¸</span>',
      'mild': '<span class="layui-badge layui-bg-green">ä½ç­‰ç–²åŠ³</span>',
      'moderate': '<span class="layui-badge layui-bg-orange">ä¸­ç­‰ç–²åŠ³</span>',
      'severe': '<span class="layui-badge layui-bg-red">é«˜ç­‰ç–²åŠ³</span>'
    };
    return badges[fatigue_level] || '<span class="layui-badge layui-bg-blue">æ­£å¸¸</span>';
  }

  function getStatusBadge(status) {
    var badges = {
      'pending': '<span class="layui-badge layui-bg-gray">å¾…å¤„ç†</span>',
      'completed': '<span class="layui-badge layui-bg-green">å·²å®Œæˆ</span>',
      'processed': '<span class="layui-badge layui-bg-green">å·²å¤„ç†</span>',
      'ignored': '<span class="layui-badge layui-bg-orange">å·²å¿½ç•¥</span>'
    };
    return badges[status] || '<span class="layui-badge">æœªçŸ¥</span>';
  }

  // æŸ¥çœ‹è®°å½•æŒ‰é’®äº‹ä»¶ç»‘å®š
  $(document).on('click', '.view-record-btn', function() {
    var recordId = $(this).data('id');
    layer.msg('æŸ¥çœ‹è®°å½•åŠŸèƒ½å¼€å‘ä¸­...', {icon: 1});
  });

  // åˆ é™¤è®°å½•æŒ‰é’®äº‹ä»¶ç»‘å®š
  $(document).on('click', '.delete-record-btn', function() {
    var recordId = $(this).data('id');
    showConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼', function() {
      $.ajax({
        url: '/api/records/' + recordId,
        type: 'DELETE',
        success: function(response) {
          if (response.success) {
            showSuccess('è®°å½•åˆ é™¤æˆåŠŸ');
            loadRecords();
          } else {
            showError('åˆ é™¤å¤±è´¥ï¼š' + response.message);
          }
        },
        error: function(xhr, status, error) {
          showError('åˆ é™¤å¤±è´¥ï¼š' + error);
        }
      });
    });
  });

  // ä¿®æ”¹è®°å½•æŒ‰é’®äº‹ä»¶ç»‘å®š
  $(document).on('click', '.edit-record-btn', function() {
    var recordId = $(this).data('id');
    var html = `
      <form class="layui-form" lay-filter="fatigueForm" style="padding:20px 30px 10px 20px;">
        <div class="layui-form-item">
          <label class="layui-form-label">ç–²åŠ³ç¨‹åº¦</label>
          <div class="layui-input-block">
            <select id="fatigue-select" name="fatigue_level" lay-verify="required">
              <option value="normal">æ­£å¸¸</option>
              <option value="mild">ä½ç­‰ç–²åŠ³</option>
              <option value="moderate">ä¸­ç­‰ç–²åŠ³</option>
              <option value="severe">é«˜ç­‰ç–²åŠ³</option>
            </select>
          </div>
        </div>
      </form>`;

    layer.open({
      type: 1,
      title: 'è¯·é€‰æ‹©æ–°çš„ç–²åŠ³ç¨‹åº¦',
      area: ['360px', '240px'],
      content: html,
      success: function(){
        layui.use(['form'], function(){
          var form = layui.form;
          form.render('select', 'fatigueForm');
        });
      },
      btn: ['ç¡®å®š', 'å–æ¶ˆ'],
      yes: function(index) {
        var fatigueLevel = $('#fatigue-select').val();

        $.ajax({
          url: '/api/records/' + recordId,
          type: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify({fatigue_level: fatigueLevel}),
          success: function(response) {
            if (response.success) {
              showSuccess('ä¿®æ”¹æˆåŠŸ');
              loadRecords();
            } else {
              showError('ä¿®æ”¹å¤±è´¥ï¼š' + response.message);
            }
          },
          error: function(xhr, status, error) {
            showError('ä¿®æ”¹å¤±è´¥ï¼š' + error);
          }
        });
        layer.close(index);
      }
    });
  });
});
{% endblock %}